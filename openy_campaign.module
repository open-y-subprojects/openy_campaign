<?php

/**
 * @file
 * Module file.
 */

use Drupal\Component\Utility\Unicode;
use Drupal\Core\Entity\ContentEntityTypeInterface;
use Drupal\Core\Url;
use Drupal\Core\Link;

/**
 * Implements hook_theme().
 */
function openy_campaign_theme($existing, $type, $theme, $path) {
  return [
    // Campaign menu.
    'openy_campaign_campaign_menu' => [
      'variables' => [
        'base_path' => base_path(),
        'links' => [],
      ],
      'template' => 'openy-campaign-campaign-menu',
    ],
    // Popup template.
    'openy_campaign_popup' => [
      'variables' => [
        'form' => NULL,
      ],
      'template' => 'openy-campaign-popup',
    ],
    // Registration popup text
    'openy_campaign_register_text' => [
      'variables' => [
        'text' => NULL,
      ],
      'template' => 'openy-campaign-register-text',
    ],
    // Winners block text
    'openy_campaign_winners' => [
      'variables' => [
        'title' => NULL,
        'members' => [],
        'prizes' => [],
      ],
      'template' => 'openy-campaign-winners',
    ],
    // Activity tracking form.
    'openy_campaign_activity_form' => [
      'render element' => 'form',
    ],
    // Visits goal block.
    'openy_campaign_visits_goal' => [
      'variables' => [
        'goal' => NULL,
        'current' => NULL,
      ],
      'template' => 'openy-campaign-visits-goal',
    ],

    // Instant Game: Magic Ball
    'openy_campaign_game_magic_ball' => [
      'variables' => [
        'link' => NULL,
        'result' => NULL,
      ],
      'template' => 'games/magic-ball',
    ],

    // Instant Game: Scratchpad
    'openy_campaign_game_scratchcard' => [
      'variables' => [
        'link' => NULL,
        'result' => NULL,
      ],
      'template' => 'games/scratchcard',
    ],

    // Instant Game: Flip Card
    'openy_campaign_game_flip_cards' => [
      'variables' => [
        'link' => NULL,
        'result' => NULL,
      ],
      'template' => 'games/flip-cards',
    ],

  ];
}

/**
 * Implements hook_token_info().
 */
function openy_campaign_token_info() {
  $type = array(
    'name' => t('Campaigns'),
    'description' => t('Tokens related to campaigns.'),
  );

  // Custom tokens for Campaign node.
  $node['login-link'] = array(
    'name' => t('Login link'),
    'description' => t('Show Member login link for campaign (linked text from Campaign edit page).'),
  );
  $node['register-link'] = array(
    'name' => t('Registration link'),
    'description' => t('Show Member registration URL for campaign (linked text from Campaign edit page).'),
  );
  $node['check-back-date'] = array(
    'name' => t('Check back on XX DATE'),
    'description' => t('Specific date text entered in Campaign edit page'),
  );

  return array(
    'types' => array('campaign' => $type),
    'tokens' => array('campaign' => $node),
  );
}

/**
 * Implements hook_tokens().
 */
function openy_campaign_tokens($type, $tokens, array $data, array $options, \Drupal\Core\Render\BubbleableMetadata $bubbleable_metadata) {
  $replacements = [];
  if ($type != 'campaign') {
    return [];
  }

  // Get node from current page URL and check referenced campaign.
  /** @var \Drupal\Node\Entity\Node $campaign */
  $campaign = \Drupal::service('openy_campaign.campaign_menu_handler')->getCampaignNodeFromRoute();

  foreach ($tokens as $name => $original) {
    switch ($name) {
      case 'login-link':
        $text = $campaign->field_token_login_link_text->value;

        $url = Url::fromRoute('openy_campaign.member-action',
          ['action' => 'login', 'campaign_id' => $campaign->id()]
        );
        $url->setOptions([
          'attributes' => [
            'class' => [
              'use-ajax',
              'login'
            ],
          ],
        ]);
        $replacements[$original] = Link::fromTextAndUrl($text, $url)->toString();;
        break;

      case 'register-link':
        $text = $campaign->field_token_register_link_text->value;

        $url = Url::fromRoute('openy_campaign.member-action',
          ['action' => 'registration', 'campaign_id' => $campaign->id()]
        );
        $url->setOptions([
          'attributes' => [
            'class' => [
              'use-ajax',
              'register'
            ],
          ],
        ]);
        $replacements[$original] = Link::fromTextAndUrl($text, $url)->toString();
        break;

      case 'check-back-date':
        $replacements[$original] = $campaign->field_token_check_back_date->value;
        break;
    }
  }
  return $replacements;
}

/**
 * Implements hook_cron().
 */
function openy_campaign_cron() {
  // Check if cron was run less then 23 hrs ago and at 2 AM.
  $lastRun = \Drupal::state()->get('openy_campaign.cron_visits_last_run', 0);
  $current = new \DateTime();
  $currentHour = $current->format('H');
  if ((\Drupal::time()->getRequestTime() - $lastRun) < 23 * 60 * 60 || ($currentHour != 2)) {
    return FALSE;
  }

  /** @var \Drupal\openy_campaign\RegularUpdater $regularUpdater */
  $regularUpdater = \Drupal::service('openy_campaign.regular_updater');

  /**
   * Test data:
   *
   * MasterCustomerId - 2052250592, FacilityCardNumber - 4000301612, 2 visits 2017-08-15 and 2017-08-16
   * MasterCustomerId - 2030086900, FacilityCardNumber - 4000044307, 1 visit 2017-08-15
   */
  // Yesterday date - From.
  $dateFrom = new \DateTime();
  //    $dateFrom->setDate(2017, 8, 15)->setTime(0, 0, 0);
  $dateFrom->sub(new \DateInterval('P1D'))->setTime(0, 0, 0);

  // Yesterday date - To.
  $dateTo = new \DateTime();
  //    $dateTo->setDate(2017, 8, 16)->setTime(23, 59, 59);
  $dateTo->sub(new \DateInterval('P1D'))->setTime(23, 59, 59);

  $regularUpdater->createQueue($dateFrom, $dateTo);

  // Update last run.
  \Drupal::state()->set('openy_campaign.cron_visits_last_run', \Drupal::time()->getRequestTime());
}

/**
 * Implements template_preprocess_node().
 */
function openy_campaign_preprocess_node(&$variables, $hook) {
  // Find which published Landing page needs to be rendered on Campaign page.
  if ($variables['node']->getType() == 'campaign' && $variables['view_mode'] == 'full') {
    $campaignMenuService = \Drupal::service('openy_campaign.campaign_menu_handler');
    $requestLandingPage = $campaignMenuService->showRequestLandingPage($variables['node']);

    $build = \Drupal::entityTypeManager()->getViewBuilder('node')->view($requestLandingPage);
    $variables['content']['landing_page'] = $build;

    $variables['#attached']['library'][] = 'openy_campaign/campaign_modal';
  }
}

/**
 * Implements hook_entity_type_build().
 */
function openy_campaign_entity_type_build(array &$entity_types) {
  /** @var \Drupal\Core\Entity\EntityTypeInterface[] $entity_types */
  foreach ($entity_types as &$entity_type) {
    if ($entity_type instanceof ContentEntityTypeInterface) {
      // Override handler by custom implementation.
      $entity_type->setHandlerClass('entity_clone', 'Drupal\openy_campaign\EntityClone\Content\ContentEntityCloneBase');
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Forbid editing some Member entity fields from admin panel.
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 */
function openy_campaign_form_openy_campaign_member_edit_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $readonlyFields = [
    'membership_id',
    'personify_id',
    'personify_email'
  ];
  foreach ($readonlyFields as $field) {
    $form[$field]['widget'][0]['value']['#attributes'] = ['readonly' => 'readonly'];
  }
}

/**
 * Implements hook_field_widget_form_alter().
 */
function openy_campaign_field_widget_form_alter(&$element, \Drupal\Core\Form\FormStateInterface $form_state, $context) {
  $fieldName = $context['items']->getName();
  $landingFields = [
    'field_campaign_pages',
    'field_my_progress_page',
    'field_pause_landing_page',
    'field_rules_prizes_page',
  ];
  if (in_array($fieldName, $landingFields)) {
    // Output publishing dates in the backend.
    /** @var \Drupal\node\Entity\Node $node */
    $node = $element['target_id']['#default_value'];
    if (empty($node)) {
      return;
    }

    $publishOn = $unpublishOn = NULL;

    $date_formatter = \Drupal::service('date.formatter');
    if (!empty($node->publish_on->value) && $node->publish_on->value && is_numeric($node->publish_on->value)) {
      $publishOn = $date_formatter->format($node->publish_on->value, 'short');
    }
    if (!empty($node->unpublish_on->value) && $node->unpublish_on->value && is_numeric($node->unpublish_on->value)) {
      $unpublishOn = $date_formatter->format($node->unpublish_on->value, 'short');
    }

    $templateString = '';
    if (!empty($publishOn) && !empty($unpublishOn)) {
      $templateString = 'active from <i>@publish_on</i> to <i>@unpublish_on</i>';
    }
    else if (empty($publishOn) && !empty($unpublishOn)) {
      $templateString = 'active until <i>@unpublish_on</i>';
    }
    else if (!empty($publishOn) && empty($unpublishOn)) {
      $templateString = 'active since <i>@publish_on</i>';
    }

    $message = t($templateString, [
      '@publish_on' => $publishOn,
      '@unpublish_on' => $unpublishOn,
    ]) . ' <a href="' . $node->url('edit-form') . '">' . t('Edit page') . '</a>';

    $element['#suffix'] = '<div class="publishing-dates">' . $message . '</div>';
  }

}

/**
 * Manually create checkin. To be used for testing.
 *
 * @param $campaignMemberId
 * @param $dateString
 */
function openy_campaign_create_checkin($campaignMemberId, $dateString) {
  $date = new \DateTime($dateString);
  $checkin = \Drupal\openy_campaign\Entity\MemberCheckin::create([
    'member' => $campaignMemberId,
    'date' => $date->format('U'),
  ]);
  $checkin->save();
}

/**
 * Clean email from Personify.
 *
 * @param string $email
 *   Email.
 *
 * @return string
 *   Email.
 */
function cleanPersonifyEmail($email) {
  $email = Unicode::strtolower($email);
  if (Unicode::substr($email, -1, 1) == '.') {
    $email = Unicode::substr($email, 0, Unicode::strlen($email) - 1);
  }
  if (Unicode::substr($email, 0, 1) == '/') {
    $email = Unicode::substr($email, 1, Unicode::strlen($email));
  }

  return $email;
}
